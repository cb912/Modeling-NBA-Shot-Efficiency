---
title: "Modeling Shot Efficiency in the NBA "
author: "Stat guys: Lewis Eatherton, Chris Yang, Charlie Bonetti"
date: "10/28/20"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE)
library(patchwork)
library(tidyverse)
library(knitr)
library(broom)
library(leaps)
theme_set(theme_bw())
shots <- read_csv("data/shot_logs.csv")
```

Your written report goes here! Before you submit, Make sure your code chunks are turned off with `echo = FALSE` and there are no warnings or messages with `warning = FALSE` and `message = FALSE` 

### Introduction

For our STA 210 Final Project, our group is interested in investigating how certain factors may have an influence on a basketball players’ shot efficiency during a game in the National Basketball Association (NBA). We are all avid NBA enthusiasts and express great curiosity in what makes a good shot versus a bad shot. This is an exciting opportunity to explore the presence or absence of certain variables that surprisingly, or unsurprisingly, have an effect on scoring a basketball shot, also known as shot success.

Our interest in this subject matter was piqued by an 2015 article titled “Basketball Shot Types and Shot Success in Different Levels of Competitive Basketball” published by Frane Erčulj and Erik Štrumbel. The study described the effect of different shot types on shot success across different levels of competition. It was insightful to learn that there were no discernable differences between different situational variables, such as the type of player (e.g. Center) or where he shot the ball (e.g. in the paint) on shot success between levels. Since it was demonstrated that the effect of situation variables on shot success remained constant throughout all levels of competition, we were motivated to identify what exactly these situation variables might be, and to what degree of influence they had on an individual’s shot success. 

As a result, we formulated our research question: “Do certain situational variables during an NBA game have an effect on a basketball player's shot success?” Based on our prior knowledge of the game of basketball, we recognize that both players and coaches deem certain shots as “great” as "bad". Yet, what qualities characterize these shots to fall under those two distinct categories? Furthermore, through our own intuition after watching countless games and playing the sport ourselves, we hypothesize that some situational variables (e.g. shot distance from the hoop or the proximity of the closest defender) will have a greater effect on an NBA player’s shot success than other situational variables. It seems intuitive that, as the time left on the clock and distance to the defender decrease, the likelihood of making a shot increases. To what extent is this true? Seeking clarity in how these factors, amongst others, contribute to a successful shot are the key objectives of our analysis. 

### Data

To seek answers to our series of questions, we will explore data from the 2014-2015 National Basketball Association (NBA) season. The data was originally collected via the NBA API PHP Library, a software tool developed by Jason Roman which scrapes historical information of past games, including statistical data, from previous seasons off of the NBA website. The data from the NBA website was acquired via manual documentation by analysts at the scoring table during games as well as computer vision techniques that track numbers such as scores, assists, etc.

Each observation in our data set is a unique shot that was taken in an NBA basketball game during the 2014-2015 season. Each observations is characterized by 21 features, including factors such as the game matchup, player name, and shot result. In total, there are 128,069 observations within the data set. For our project, the response variable of interest is shot success. This value determines the whether or not a successful shot was made after all relevant predictor values were taken into consideration. 

The response variable we are interested in investigating is:

- `SHOT_SUCCESS`: An indicator variable quantifying whether or not the shot was made.

The predictor variables that we expect to have an influence on the response variable are:

- `SHOT_NUMBER`: Shot number for a given player in a specific game (e.g. 8 denotes the player’s 8th shot in game)
- `SHOT_CLOCK`: Number of seconds left on the shot clock when the player shot the ball
- `SHOT_DIST (FT)`: Distance in feet from the hoop when the player shot the ball 
- `SHOT_RESULT`: Whether the shot was "made" or "missed"
- `DRIBBLES`: Number of dribbles before the player shot the ball 
- `TOUCH_TIME (SEC)`: Number of seconds before the player shot the ball (after being passed to)
- `PTS_TYPE`: Whether the shot was 2 or 3-pointer
- `CLOSEST_DEFENDER`: Who the closest defender was to the shooting player
- `CLOSE_DEF_DIST`: Number of feet the defender was from the player when the ball was shot
- `Player_name`: Who shot the ball

```{r}
glimpse(shots)
```

### Data Cleansing
```{r}
shots <- shots %>%
  mutate(SHOT_SUCCESS = case_when(
    SHOT_RESULT == "made" ~ 1,
    SHOT_RESULT == "missed" ~ 0))

shots <- shots %>%
  mutate(SHOT_SUCCESS = as.factor(SHOT_SUCCESS))
```


```{r}
apply(apply(shots,2,is.na),2,sum)

shots <- shots %>%
  drop_na(SHOT_CLOCK)
```
Analysis of missing data reveals that only one variable contains unavailable values. To accommodate for this, we removed 5567 missing values from the dataset since they accounted for only `r 5567/128069 * 100` percent of all observations, which is an inconsequential amount. 

### Exploratory Data Analysis
```{r}
p1 <- ggplot(data = shots, aes(x = SHOT_DIST), freq = TRUE) +
  geom_histogram(fill = "darkorange") +
  labs(x = "Shot Distance (ft)",
       y = 'Number of Shots',
       title = "Distribution of shots during 2014-2015 NBA season")

p2 <- ggplot(data = shots, aes(x = SHOT_SUCCESS, y = SHOT_DIST)) +
  geom_boxplot(fill = "darkorange") + 
  labs(x = "Shot Success", 
       y = "Shot Distance (ft)",
       title = "Further away shots are more likely to miss") 

p3 <- ggplot(shots, aes(x = SHOT_DIST, color = SHOT_SUCCESS)) + 
  geom_density() +
  labs(x = "Shot Distance (ft)",
       y = "Proportion",
       title = "Density of 2-point shots versus 3-point shots")

p1 + p2 + p3
```

```{r}
p3 <- ggplot(data=shots, aes(x = SHOT_DIST, y= CLOSE_DEF_DIST)) + 
  geom_point(aes(color=SHOT_SUCCESS)) +
  labs(x = "Shot distance (ft)",
       y = "Distance from closest defender (ft)",
       title = "Made shots are closer to the basket and further away from the defender")
p3
```


```{r}
##Checking conditions

### Linearity
library(Stat2Data)

emplogitplot1(SHOT_SUCCESS ~ SHOT_CLOCK, data = shots, 
              ngroups = 5)

emplogitplot1(SHOT_SUCCESS ~ CLOSE_DEF_DIST, data = shots, 
              ngroups = 10)

emplogitplot1(SHOT_SUCCESS ~ SHOT_DIST, data = shots, 
              ngroups = 10)

emplogitplot1(SHOT_SUCCESS ~ TOUCH_TIME, data = shots, 
              ngroups = 10)


shots %>%
  count(CLOSEST_DEFENDER, SHOT_SUCCESS) %>%
  group_by(CLOSEST_DEFENDER) %>%
  mutate(prop = n/sum(n)) %>%
  filter(SHOT_SUCCESS == "1") %>%
  mutate(emp_logit = log(prop/(1-prop)))


shots_players <- shots %>%
  filter(CLOSEST_DEFENDER == "Leonard, Kawhi"| CLOSEST_DEFENDER ==  "Curry, Stephen")

shots_players <- shots_players %>%
  filter(CLOSE_DEF_DIST < 5)

shots_players <- shots_players %>%
  mutate(SHOT_SUCCESS = as.factor(SHOT_SUCCESS))

shots_players <- shots_players %>%
  mutate(CLOSEST_DEFENDER = as.factor(CLOSEST_DEFENDER))

emplogitplot2(SHOT_SUCCESS ~ CLOSE_DEF_DIST + CLOSEST_DEFENDER, data = shots_players)

```

Linearity is not totally satisfied... graphs aren't linear

independence and randomness seems fine accorind to how data was collected

we should also look into collinearity

### Creating Model
```{r}

full_mod <- glm(SHOT_SUCCESS ~ SHOT_CLOCK + DRIBBLES + TOUCH_TIME + SHOT_DIST + CLOSE_DEF_DIST, data = shots, family = "binomial")

drop1(full_mod)


full_mod <- glm(SHOT_SUCCESS ~ SHOT_CLOCK + DRIBBLES + TOUCH_TIME + SHOT_DIST + CLOSE_DEF_DIST + CLOSEST_DEFENDER, data = shots_players, family = "binomial")

drop1(full_mod)

current <- glm(SHOT_SUCCESS ~ SHOT_CLOCK + TOUCH_TIME + SHOT_DIST + CLOSE_DEF_DIST + CLOSEST_DEFENDER, data = shots_players, family = "binomial")
drop1(current)

current <- glm(SHOT_SUCCESS ~ SHOT_CLOCK + TOUCH_TIME + SHOT_DIST + CLOSE_DEF_DIST, data = shots_players, family = "binomial")
drop1(current)

current <- glm(SHOT_SUCCESS ~ SHOT_CLOCK + SHOT_DIST + CLOSE_DEF_DIST, data = shots_players, family = "binomial")
drop1(current)


### testing for this interaction term

current_interaction <- glm(SHOT_SUCCESS ~ SHOT_CLOCK + SHOT_DIST + CLOSE_DEF_DIST + CLOSE_DEF_DIST * CLOSEST_DEFENDER, data = shots_players, family = "binomial")

anova(current, current_interaction, test = "Chisq") %>%
  tidy()

current%>%
  tidy() %>%
  kable(digits = 3)


```

talk about final model outcome and how we came to it

###Discussion

Limitations:

1) Out of all predictor variables in analysis, only one variable had missing observations; there were 5,567 unavailable values for the variable which counted the time left on the shot clock when the player shot the ball. This may have been due to recording error or instances where the shot clock was turned off. Given that 5,567 is marginal compared to the total number of observations (128,069), we chose to remove all rows containing NAs for this variable from the dataset. As a result, The dataset wouldn't differ to a significant degree systematically compared to the larger population.
2) The variable which quantified the number of seconds where a player touched the ball was negative 

Next steps:

1) To address the limitation of _____, 
2) Furthermore, an avenue we would be interested in exploring how the situational variables of making a successful shot may differ or stay the same during "clutch" scenarios, where the outcome of a game is at stake. In this case, we could explore other predictors within our model and set thresholds, such as having less than 10 seconds left during the game, being in the 4th period of the game, and having a final margin of victory of less than or equal to 3 points. Furthermore, another avenue we would be interested in exploring is the effectiveness of different defenders on a player's shot success in NBA games. In the current stage of our project, we investigated the variables that played in a role in optimizing a successful shot. Out of curiosity, how would these factors change if we explored the data from the perspective of the defender, who is attempting to prevent a player from scoring a basket? Further analysis of the distance between contested shots as well as field goal percentage could yield interesting factors that may have some degree of influence on defending a shot. Additionally, based on these characteristics and others, perhaps we could identify which NBA players constitute the "elite" class of the defensive side of basketball.

Talk about our results, the limitations of these results, and what'd we do differently...

###References

(1) Erčulj F, Štrumbelj E (2015) Basketball Shot Types and Shot Success in Different Levels of Competitive Basketball. PLoS ONE 10(6): e0128885. https://doi.org/10.1371/journal.pone.0128885
